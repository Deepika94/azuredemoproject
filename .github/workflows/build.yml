name: Build Container Image and Push it to ACR

on:
 push:
  branches:
  - main 
  
jobs:
  build-and-push:
   runs-on: ubuntu-latest
   
   steps:
   - name: checkout Repository
     uses: actions/checkout@v2

   - name: Login to Azure Container Registry 
     uses: docker/login-action@v1
     with:
       username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
       password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}
       registry: webappacr01.azurecr.io
       
   - name: Setup Docker Buildx
     uses: docker/setup-buildx-action@v1

   - name: Build and push Docker Images
     uses: docker/build-push-action@v2
     with:
      context: .
      push: true
      tags: webappacr01.azurecr.io/mywebappacr:latest

   - name: Pull the Images from Azure ACR
     run: |
       az acr login --name webappacr01
       docker pull webappacr01.azurecr.io/mywebappacr:latest
       docker tag  webappacr01.azurecr.io/mywebappacr:latest webappacr01.azurecr.io/mywebappacr:lts

   - name: Configure Kubectl
     uses: azure/setup-kubectl@v1.0.1
     with:
      secrets: ${{ secretes.KUBECONFIG }}

   - name: Deploy application to AKS
     run: |
       kubectl apply -f /home/adm-deepika/azuredemoproject/Deployment.yaml

   - name: Update kubernetes service 
     run: | 
        kubectl apply -f /home/adm-deepika/azuredemoproject/service.yaml


     
       
       
 
